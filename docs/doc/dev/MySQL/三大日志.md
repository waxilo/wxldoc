
| 特性     | Redo Log   | Undo Log      | Binlog                  |
| ------ | ---------- | ------------- | ----------------------- |
| 所属层级   | InnoDB 引擎层 | InnoDB 引擎层    | MySQL Server 层          |
| 作用     | 崩溃恢复、持久性   | 回滚、MVCC       | 主从复制、PITR               |
| 日志类型   | 物理日志       | 逻辑日志          | 逻辑日志（可选 ROW/STATEMENT）  |
| 是否循环写  | 是          | 否（由 purge 清理） | 否（追加写，可轮转）              |
| 是否支持事务 | 是          | 是             | 是（通过 2PC 与 Redo Log 协调） |
| 默认开启   | 是（InnoDB）  | 是（InnoDB）     | 否（需配置 `log_bin`）        |


## Bin Log

### 1. 作用

- **主从复制（Replication）**：主库将 Binlog 发送给从库，从库重放实现数据同步。
- **基于时间点的恢复（Point-in-Time Recovery）**。
- 审计和数据变更追踪。

### 2. 存储位置

- 由 MySQL Server 层管理（与存储引擎无关），默认关闭，需手动开启。
- 文件名如：`mysql-bin.000001`、`mysql-bin.000002`...

### 3. 日志格式（由 `binlog_format` 控制）

- **STATEMENT**：记录 SQL 语句（节省空间，但某些函数如 `NOW()`、`RAND()` 可能导致主从不一致）。
- **ROW**：记录每一行数据的变化（精确，但日志量大）。
- **MIXED**：混合模式，MySQL 自动选择。

### 4. 写入机制

- 事务提交时，先写 Redo Log（Prepare 状态），再写 Binlog，最后 Redo Log 提交（Commit）——这就是 **两阶段提交（2PC）**，用于保证 Redo Log 与 Binlog 的一致性。

### 5. 特点

- **追加写入（Append-only）**，不会覆盖。
- 可通过 `expire_logs_days` 或 `binlog_expire_logs_seconds` 自动清理。
- 不参与崩溃恢复（但可用于 PITR）。
- 


## Redo Log

### 1. 作用

- **保证事务的持久性（Durability）**。
- 在数据库发生异常宕机时，用于**崩溃恢复（Crash Recovery）**，确保已提交事务的修改不会丢失。

### 2. 存储位置

- 物理文件，通常位于数据目录下，如：
    - `ib_logfile0`
    - `ib_logfile1`

### 3. 写入机制

- Redo Log 是 **InnoDB 存储引擎**特有的日志。
- 采用 **WAL（Write-Ahead Logging）** 机制：先写日志，再写磁盘数据页。
- 日志内容记录的是 **物理级别的页修改**（例如：“将数据页 X 的偏移 Y 处的值改为 Z”）。
- Redo Log 是**循环写入**的，有固定大小（由 `innodb_log_file_size` 和 `innodb_log_files_in_group` 控制）。

### 4. 特点

- **顺序写**，性能高。
- 只记录“做了什么”，不记录“如何撤销”。
- 在事务提交时，Redo Log 必须刷盘（根据 `innodb_flush_log_at_trx_commit` 设置决定刷盘策略）。

## Undo Log

### 1. 作用

- **实现事务的原子性（Atomicity）** 和 **MVCC（多版本并发控制）**。
- 用于 **回滚未提交的事务**。
- 支持 **一致性读（Consistent Read）**，即其他事务可以看到事务开始前的数据快照。

### 2. 存储位置

- 存储在 **共享表空间（ibdata1）** 或 **独立的 Undo 表空间**（MySQL 5.6+ 可配置）。

### 3. 写入机制

- Undo Log 记录的是 **逻辑操作的反向操作**（例如：INSERT 对应 DELETE，UPDATE 记录旧值）。
- 属于 **逻辑日志**。
- 在事务执行过程中生成，在事务提交后不一定立即删除（可能被 MVCC 使用），由 purge 线程异步清理。

### 4. 特点

- 不用于崩溃恢复（崩溃恢复靠 Redo Log）。
- 是实现 **可重复读（Repeatable Read）** 隔离级别的关键。


## 两阶段提交（2PC）

1. **Prepare 阶段**：InnoDB 将 Redo Log 写入并标记为 prepare 状态。
2. **写 Binlog**：MySQL Server 层写入 Binlog。
3. **Commit 阶段**：InnoDB 将 Redo Log 标记为 commit 状态。

若在第 2 步崩溃，重启后会检查 Redo Log 中处于 prepare 状态的事务，若对应 Binlog 存在，则提交；否则回滚。从而保证 Redo Log 与 Binlog 的一致性。