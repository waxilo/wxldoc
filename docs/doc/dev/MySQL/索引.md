## 聚簇索引

在innodb存储引擎下，每个表有且只有一个聚簇索引，通常为主键或隐藏主键。

## B+树

### 为什么选择 B+ 树？

| 数据结构     | 是否适合磁盘存储 | 范围查询      | 插入/删除效率  | 说明            |
| -------- | -------- | --------- | -------- | ------------- |
| 二叉搜索树    | ❌        | ✅         | ❌（退化为链表） | 高度不可控         |
| 平衡树（AVL） | ❌        | ✅         | ⚠️（频繁旋转） | 仍太高，I/O 多     |
| B 树      | ✅        | ⚠️（需中序遍历） | ✅        | 数据存在内部节点      |
| B+ 树     | ✅✅       | ✅✅        | ✅✅       | 数据只在叶子，叶子链表连接 |
✅ **B+ 树优势**：

- **高度低**：一个节点可存多个 key，减少磁盘 I/O（通常 3～4 层可存千万级数据）
- **范围查询高效**：叶子节点用双向链表连接，顺序扫描快
- **全表扫描友好**：只需遍历叶子链表
- **稳定性好**：插入/删除不会频繁调整树结构

## 索引失效场景

| 场景                       | 示例                                                                                               |
| ------------------------ | ------------------------------------------------------------------------------------------------ |
| 索引列使用函数                  | SELECT * FROM users WHERE YEAR(create_time) = 2025;                                              |
| 索引列参与运算                  | SELECT * FROM orders WHERE amount > 100 / 1.1;                                                   |
| 类型隐式转换                   | -- 假设 phone 是 VARCHAR 类型<br>SELECT * FROM users WHERE phone = 13800138000;                       |
| 使用 `!=` 或 `<>`（非等值查询）    | -- 可能失效（除非走覆盖索引） <br>SELECT * FROM users WHERE status != 1;                                      |
| 使用 `NOT IN`、`NOT EXISTS` | SELECT * FROM users WHERE id NOT IN (SELECT user_id FROM orders);                                |
| `LIKE` 以通配符开头（前导模糊）      | SELECT * FROM users WHERE name LIKE '%john%';                                                    |
| 组合索引非最左匹配                | -- 假设（a,b,c）索引<br>SELECT * FROM users WHERE  b = 2 AND c = 3；                                    |
| `OR` 条件中部分列无索引           | -- 假设只有 idx_name(name) 索引 ，age 无索引<br>SELECT * FROM users WHERE name = 'Alice' OR age = 25;      |
| 数据倾斜                     | -- 比如 gender 字段：99% 是 'M'，1% 是 'F'，即使有索引，查 'M' 时可能走全表<br>SELECT * FROM users WHERE gender = 'M'; |
| `SELECT *`回标成本高，放弃使用索引   | SELECT * from users                                                                              |
